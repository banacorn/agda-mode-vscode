// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Assert = require("assert");
var Vscode = require("vscode");
var Nodefs = require("node:fs");
var Nodeos = require("node:os");
var Nodepath = require("node:path");
var Connection__Download__GitHub$AgdaModeVscode = require("../../../src/Connection/Resolver/Download/Connection__Download__GitHub.bs.js");

var $$TextEncoder = {};

describe("Connection Download", (function () {
        this.timeout(10000);
        describe("isDownloading", (function () {
                it("should return false and create directory when global storage directory doesn't exist", (async function () {
                        var nonExistentDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-test-" + String(Date.now() | 0));
                        Assert.ok(!Nodefs.existsSync(nonExistentDir));
                        var globalStorageUri = Vscode.Uri.file(nonExistentDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result);
                        Assert.ok(Nodefs.existsSync(nonExistentDir));
                        Nodefs.rmdirSync(nonExistentDir);
                      }));
                it("should return false when directory exists but no in-flight download file is present", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-exists-" + String(Date.now() | 0));
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        Assert.ok(Nodefs.existsSync(tempDir));
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        Assert.ok(!Nodefs.existsSync(inFlightFile));
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should return true when in-flight download file exists", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-inflight-" + String(Date.now() | 0));
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        Nodefs.writeFileSync(inFlightFile, Buffer.from("downloading..."));
                        Assert.ok(Nodefs.existsSync(tempDir));
                        Assert.ok(Nodefs.existsSync(inFlightFile));
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(result);
                        Nodefs.unlinkSync(inFlightFile);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should return false when directory exists with other files but no in-flight download file", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-otherfiles-" + String(Date.now() | 0));
                        var otherFile = Nodepath.join(tempDir, "some-other-file.txt");
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        Nodefs.writeFileSync(otherFile, Buffer.from("other content"));
                        Assert.ok(Nodefs.existsSync(tempDir));
                        Assert.ok(Nodefs.existsSync(otherFile));
                        Assert.ok(!Nodefs.existsSync(inFlightFile));
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result);
                        Nodefs.unlinkSync(otherFile);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should handle multiple calls consistently when no download is in progress", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-multiple-" + String(Date.now() | 0));
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result1 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        var result2 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        var result3 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result1);
                        Assert.ok(!result2);
                        Assert.ok(!result3);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should handle multiple calls consistently when download is in progress", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-multiple-progress-" + String(Date.now() | 0));
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        Nodefs.writeFileSync(inFlightFile, Buffer.from("downloading..."));
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result1 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        var result2 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        var result3 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(result1);
                        Assert.ok(result2);
                        Assert.ok(result3);
                        Nodefs.unlinkSync(inFlightFile);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should transition from not downloading to downloading when in-flight file is created", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-transition-" + String(Date.now() | 0));
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result1 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result1);
                        Nodefs.writeFileSync(inFlightFile, Buffer.from("downloading..."));
                        var result2 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(result2);
                        Nodefs.unlinkSync(inFlightFile);
                        var result3 = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result3);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should handle edge case with empty in-flight file", (async function () {
                        var tempDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-empty-" + String(Date.now() | 0));
                        var inFlightFile = Nodepath.join(tempDir, "in-flight.download");
                        await Nodefs.promises.mkdir(tempDir, {
                              recursive: true,
                              mode: 511
                            });
                        Nodefs.writeFileSync(inFlightFile, Buffer.from(""));
                        Assert.ok(Nodefs.existsSync(tempDir));
                        Assert.ok(Nodefs.existsSync(inFlightFile));
                        var globalStorageUri = Vscode.Uri.file(tempDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(result);
                        Nodefs.unlinkSync(inFlightFile);
                        Nodefs.rmdirSync(tempDir);
                      }));
                it("should create directory with proper permissions when it doesn't exist", (async function () {
                        var nonExistentDir = Nodepath.join(Nodeos.tmpdir(), "agda-isdownloading-permissions-" + String(Date.now() | 0));
                        Assert.ok(!Nodefs.existsSync(nonExistentDir));
                        var globalStorageUri = Vscode.Uri.file(nonExistentDir);
                        var result = await Connection__Download__GitHub$AgdaModeVscode.Module.isDownloading(globalStorageUri);
                        Assert.ok(!result);
                        Assert.ok(Nodefs.existsSync(nonExistentDir));
                        var testFile = Nodepath.join(nonExistentDir, "test.txt");
                        Nodefs.writeFileSync(testFile, Buffer.from("test"));
                        Assert.ok(Nodefs.existsSync(testFile));
                        Nodefs.unlinkSync(testFile);
                        Nodefs.rmdirSync(nonExistentDir);
                      }));
              }));
      }));

var GitHub;

exports.GitHub = GitHub;
exports.$$TextEncoder = $$TextEncoder;
/*  Not a pure module */
