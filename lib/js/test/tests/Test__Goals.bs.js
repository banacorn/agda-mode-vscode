// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("rescript/lib/js/curry.js");
var Assert = require("assert");
var Vscode = require("vscode");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Goal$AgdaModeVscode = require("../../src/Goal.bs.js");
var Goals$AgdaModeVscode = require("../../src/Goals.bs.js");
var Editor$AgdaModeVscode = require("../../src/Editor.bs.js");
var Test__Util$AgdaModeVscode = require("./Test__Util.bs.js");

describe("Goals", (function () {
        var fileContent = {
          contents: ""
        };
        before(async function () {
              fileContent.contents = await Test__Util$AgdaModeVscode.$$File.read(Test__Util$AgdaModeVscode.Path.asset("Goals.agda"));
            });
        afterEach(async function () {
              return await Test__Util$AgdaModeVscode.$$File.write(Test__Util$AgdaModeVscode.Path.asset("Goals.agda"), fileContent.contents);
            });
        after(async function () {
              return await Test__Util$AgdaModeVscode.$$File.write(Test__Util$AgdaModeVscode.Path.asset("Goals.agda"), fileContent.contents);
            });
        describe("Handle `onDidChangeTextDocument`", (function () {
                it("should instantiate all 5 goals with question marks expanded to holes", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#2 [10:20-27)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                        var actual = await Test__Util$AgdaModeVscode.$$File.read(Test__Util$AgdaModeVscode.Path.asset("Goals.agda"));
                        var expected = await Test__Util$AgdaModeVscode.$$File.read(Test__Util$AgdaModeVscode.Path.asset("Goals.agda.out"));
                        return Curry._3(Assert.deepStrictEqual, actual, expected, undefined);
                      }));
                it("should translate goals on an insertion immediately before a goal", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.insert(ctx.state.editor, new Vscode.Position(8, 18), " ", undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:20-27)",
                              "#2 [10:20-27)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                it("should translate goals on an insertion immediately after a goal", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.insert(ctx.state.editor, new Vscode.Position(8, 25), " ", undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#2 [10:20-27)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                it("should destroy a goal after it has been completely deleted", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.$$delete(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26)), undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                it("should destroy a goal after it has been completely replaced 1", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.replace(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26)), "       ", undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                it("should destroy a goal after it has been completely replaced 2", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.replace(ctx.state.editor, new Vscode.Range(new Vscode.Position(10, 17), new Vscode.Position(10, 26)), "::DD", undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#2 [10:20-27)",
                              "#4 [11:22-26)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                it("should only resize a goal after its content has been edited", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        await Editor$AgdaModeVscode.$$Text.replace(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 22), new Vscode.Position(9, 23)), ":D", undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#0 [8:12-19)",
                              "#1 [9:19-26)",
                              "#2 [10:20-28)",
                              "#3 [11:19-26)",
                              "#4 [11:27-31)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
                describe.skip("Restore hole damaged boundaries", (function () {
                        it("should protect against a backspace on the right boundary", (async function () {
                                var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                                await Editor$AgdaModeVscode.$$Text.$$delete(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 25), new Vscode.Position(9, 26)), undefined);
                                await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                                var range = new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26));
                                var actual = Editor$AgdaModeVscode.$$Text.get(ctx.state.document, range);
                                Curry._3(Assert.deepStrictEqual, actual, "{!   !}", undefined);
                                return Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                                            "#0 [92-99)",
                                            "#1 [118-125)",
                                            "#2 [145-152)",
                                            "#3 [171-175)"
                                          ], undefined);
                              }));
                        it("should protect against a deletion on the right boundary", (async function () {
                                var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                                await Editor$AgdaModeVscode.$$Text.$$delete(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 24), new Vscode.Position(9, 25)), undefined);
                                await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                                var range = new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26));
                                var actual = Editor$AgdaModeVscode.$$Text.get(ctx.state.document, range);
                                Curry._3(Assert.deepStrictEqual, actual, "{!   !}", undefined);
                                return Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                                            "#0 [92-99)",
                                            "#1 [118-125)",
                                            "#2 [145-152)",
                                            "#3 [171-175)"
                                          ], undefined);
                              }));
                        it("should protect against a backspace on the left boundary", (async function () {
                                var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                                await Editor$AgdaModeVscode.$$Text.$$delete(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 20), new Vscode.Position(9, 21)), undefined);
                                await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                                var range = new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26));
                                var actual = Editor$AgdaModeVscode.$$Text.get(ctx.state.document, range);
                                Curry._3(Assert.deepStrictEqual, actual, "{!   !}", undefined);
                                return Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                                            "#0 [92-99)",
                                            "#1 [118-125)",
                                            "#2 [145-152)",
                                            "#3 [171-175)"
                                          ], undefined);
                              }));
                        it("should protect against a deletion on the left boundary", (async function () {
                                var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                                await Editor$AgdaModeVscode.$$Text.$$delete(ctx.state.editor, new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 20)), undefined);
                                await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                                var range = new Vscode.Range(new Vscode.Position(9, 19), new Vscode.Position(9, 26));
                                var actual = Editor$AgdaModeVscode.$$Text.get(ctx.state.document, range);
                                Curry._3(Assert.deepStrictEqual, actual, "{!   !}", undefined);
                                return Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                                            "#0 [92-99)",
                                            "#1 [118-125)",
                                            "#2 [145-152)",
                                            "#3 [171-175)"
                                          ], undefined);
                              }));
                      }));
              }));
        describe("`getGoalAtCursor`", (function () {
                it("should return `None` when the cursor is not in a hole", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(0, 0));
                        var actual = Goals$AgdaModeVscode.getGoalAtCursor(ctx.state.goals, ctx.state.editor);
                        return Curry._3(Assert.deepStrictEqual, actual, undefined, undefined);
                      }));
                it("should return the goal when the cursor is inside a hole", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(7, 14));
                        var actual = Core__Option.map(Goals$AgdaModeVscode.getGoalAtCursor(ctx.state.goals, ctx.state.editor), Goal$AgdaModeVscode.toString);
                        return Curry._3(Assert.deepStrictEqual, actual, "#0 [8:12-19)", undefined);
                      }));
                it("should return the goal when the cursor is immediately before a hole", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(7, 11));
                        var actual = Core__Option.map(Goals$AgdaModeVscode.getGoalAtCursor(ctx.state.goals, ctx.state.editor), Goal$AgdaModeVscode.toString);
                        return Curry._3(Assert.deepStrictEqual, actual, "#0 [8:12-19)", undefined);
                      }));
                it("should return the goal when the cursor is immediately after a hole", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(7, 18));
                        var actual = Core__Option.map(Goals$AgdaModeVscode.getGoalAtCursor(ctx.state.goals, ctx.state.editor), Goal$AgdaModeVscode.toString);
                        return Curry._3(Assert.deepStrictEqual, actual, "#0 [8:12-19)", undefined);
                      }));
              }));
        describe("Jumping between goals", (function () {
                it("should jump to the next goal", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(0, 0));
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(7, 14), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(8, 21), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(9, 22), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(10, 21), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(10, 28), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.nextGoal(ctx);
                        return Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(7, 14), undefined);
                      }));
                it("should jump to the previous goal", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Goals.agda");
                        Editor$AgdaModeVscode.Cursor.set(ctx.state.editor, new Vscode.Position(0, 0));
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(10, 28), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(10, 21), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(9, 22), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(8, 21), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(7, 14), undefined);
                        await Test__Util$AgdaModeVscode.AgdaMode.previousGoal(ctx);
                        return Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(10, 28), undefined);
                      }));
              }));
        describe("Cursor placement", (function () {
                var filename = "Goals.agda";
                it("should place the cursor inside a nearby hole after expanding it", (async function () {
                        var filepath = Test__Util$AgdaModeVscode.Path.asset(filename);
                        await Vscode.workspace.openTextDocument(filepath);
                        var editor = Vscode.window.activeTextEditor;
                        if (editor !== undefined) {
                          Editor$AgdaModeVscode.Cursor.set(Caml_option.valFromOption(editor), new Vscode.Position(8, 18));
                        } else {
                          Assert.fail("Cannot open editor for " + filename);
                        }
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad(filename);
                        return Curry._3(Assert.deepStrictEqual, Editor$AgdaModeVscode.Cursor.get(ctx.state.editor), new Vscode.Position(8, 21), undefined);
                      }));
              }));
        describe("Issue #157", (function () {
                it("should handle nested holes correctly", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Issue157.agda");
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), ["#0 [4:5-26)"], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
              }));
        describe("Issue #159", (function () {
                it("should create holes in literate agda files", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Issue159.lagda.tex");
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), ["#0 [5:5-7:3)"], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
              }));
        describe("Issue #211", (function () {
                it("should create a hole on the second line instead of the first line", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Issue211.agda");
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), ["#0 [5:5-12)"], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
              }));
        describe("Issue #214", (function () {
                it("should not create a hole in non-Agda code blocks", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Issue214.lagda.md");
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), ["#0 [9:11-17)"], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
              }));
        describe("Issue #229", (function () {
                it("should not create a hole in an indentifier with a question mark", (async function () {
                        var ctx = await Test__Util$AgdaModeVscode.AgdaMode.makeAndLoad("Issue229.agda");
                        await Test__Util$AgdaModeVscode.AgdaMode.execute(ctx, "Refine", Caml_option.some(new Vscode.Position(12, 11)), undefined);
                        Curry._3(Assert.deepStrictEqual, Goals$AgdaModeVscode.serialize(ctx.state.goals), [
                              "#1 [19:9-16)",
                              "#2 [13:13-20)",
                              "#3 [13:21-28)"
                            ], undefined);
                        return await Test__Util$AgdaModeVscode.AgdaMode.quit(ctx);
                      }));
              }));
      }));

/*  Not a pure module */
