// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Url = require("url");
var Js_exn = require("rescript/lib/js/js_exn.js");
var Vscode = require("vscode");
var Nodepath = require("node:path");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var FS$AgdaModeVscode = require("../../FS.bs.js");
var Caml_js_exceptions = require("rescript/lib/js/caml_js_exceptions.js");
var Config$AgdaModeVscode = require("../../Config.bs.js");
var Connection__URI$AgdaModeVscode = require("../Shared/Connection__URI.bs.js");
var Connection__Endpoint$AgdaModeVscode = require("../Endpoint/Connection__Endpoint.bs.js");
var Connection__Download__Util$AgdaModeVscode = require("./Download/Connection__Download__Util.bs.js");
var Connection__Download__Unzip$AgdaModeVscode = require("./Download/Connection__Download__Unzip.bs.js");
var Connection__Download__GitHub$AgdaModeVscode = require("./Download/Connection__Download__GitHub.bs.js");

function toString(x) {
  if (typeof x !== "object") {
    return "Cannot find compatible Agda Language Server release for download. Prebuilts are only available for download on Ubuntu, Windows, and macOS (arm64, x64).\nPlease build from source if you are on a different platform. \nSee https://github.com/agda/agda-language-server for more information.";
  }
  switch (x.TAG) {
    case "CannotFetchALSReleases" :
        return "Cannot fetch releases of Agda Language Server: " + Connection__Download__GitHub$AgdaModeVscode.$$Error.toString(x._0);
    case "CannotDownloadALS" :
        return "Failed to download the Agda Language Server: " + Connection__Download__GitHub$AgdaModeVscode.$$Error.toString(x._0);
    case "CannotConnectToALS" :
        return Connection__Endpoint$AgdaModeVscode.$$Error.toString(x._0);
    case "CannotDownloadFromURL" :
        return "Failed to download from URL: " + Connection__Download__GitHub$AgdaModeVscode.$$Error.toString(x._0);
    
  }
}

var $$Error = {
  toString: toString
};

function makeRepo(memento, globalStorageUri) {
  return {
          username: "agda",
          repository: "agda-language-server",
          userAgent: "agda/agda-mode-vscode",
          memento: memento,
          globalStorageUri: globalStorageUri,
          cacheInvalidateExpirationSecs: 86400
        };
}

async function getReleaseManifest(memento, globalStorageUri) {
  var match = await Connection__Download__GitHub$AgdaModeVscode.ReleaseManifest.$$fetch(makeRepo(memento, globalStorageUri));
  var error = match[0];
  if (error.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: error._0
          };
  } else {
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotFetchALSReleases",
              _0: error._0
            }
          };
  }
}

async function download(memento, globalStorageUri, fetchSpec) {
  var reportProgress = await Connection__Download__Util$AgdaModeVscode.Progress.report("Agda Language Server");
  var error = await Connection__Download__GitHub$AgdaModeVscode.download(fetchSpec, memento, globalStorageUri, reportProgress);
  if (error.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotDownloadALS",
              _0: error._0
            }
          };
  }
  var globalStoragePath = globalStorageUri.fsPath;
  var destPath = Connection__URI$AgdaModeVscode.parse(Nodepath.join(globalStoragePath, fetchSpec.saveAsFileName, "als"));
  await Config$AgdaModeVscode.Connection.addAgdaPath(destPath);
  var e = await Connection__Endpoint$AgdaModeVscode.fromURI(destPath);
  if (e.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: e._0
          };
  } else {
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotConnectToALS",
              _0: e._0
            }
          };
  }
}

async function downloadFromURL(globalStorageUri, url, saveAsFileName, displayName) {
  var reportProgress = await Connection__Download__Util$AgdaModeVscode.Progress.report(displayName);
  var destDirUri = Vscode.Uri.joinPath(globalStorageUri, saveAsFileName);
  var match = await FS$AgdaModeVscode.stat(destDirUri);
  if (match.TAG !== "Ok") {
    await FS$AgdaModeVscode.createDirectory(destDirUri);
  }
  var execPathUri = Vscode.Uri.joinPath(destDirUri, "als");
  var match$1 = await FS$AgdaModeVscode.stat(execPathUri);
  if (match$1.TAG === "Ok") {
    var execPath = execPathUri.fsPath;
    var destPath = Connection__URI$AgdaModeVscode.parse(execPath);
    await Config$AgdaModeVscode.Connection.addAgdaPath(destPath);
    var e = await Connection__Endpoint$AgdaModeVscode.fromURI(destPath);
    if (e.TAG === "Ok") {
      return {
              TAG: "Ok",
              _0: e._0
            };
    } else {
      return {
              TAG: "Error",
              _0: {
                TAG: "CannotConnectToALS",
                _0: e._0
              }
            };
    }
  }
  try {
    var urlObj = Url.parse(url);
    var host = urlObj.hostname;
    var path = urlObj.pathname + Core__Option.getOr(urlObj.search, "");
    var tempFileUri = Vscode.Uri.joinPath(destDirUri, "download.tmp");
    var httpOptions = {
      host: host,
      path: path,
      headers: {
        "User-Agent": "agda/agda-mode-vscode"
      }
    };
    var error = await Connection__Download__Util$AgdaModeVscode.asFile(httpOptions, tempFileUri, reportProgress);
    if (error.TAG === "Ok") {
      var readResult = await FS$AgdaModeVscode.readFile(tempFileUri);
      var isPKHeader;
      if (readResult.TAG === "Ok") {
        var uint8Array = readResult._0;
        isPKHeader = uint8Array.length >= 4 ? Core__Option.getOr(uint8Array[0], 0) === 80 && Core__Option.getOr(uint8Array[1], 0) === 75 && Core__Option.getOr(uint8Array[2], 0) === 3 && Core__Option.getOr(uint8Array[3], 0) === 4 : false;
      } else {
        isPKHeader = false;
      }
      if (isPKHeader) {
        var zipFileUri = Vscode.Uri.joinPath(destDirUri, "download.zip");
        await FS$AgdaModeVscode.rename(tempFileUri, zipFileUri);
        await Connection__Download__Unzip$AgdaModeVscode.run(zipFileUri, destDirUri);
        await FS$AgdaModeVscode.$$delete(zipFileUri);
        var execPath$1 = execPathUri.fsPath;
        var destPath$1 = Connection__URI$AgdaModeVscode.parse(execPath$1);
        await Config$AgdaModeVscode.Connection.addAgdaPath(destPath$1);
        var e$1 = await Connection__Endpoint$AgdaModeVscode.fromURI(destPath$1);
        if (e$1.TAG === "Ok") {
          return {
                  TAG: "Ok",
                  _0: e$1._0
                };
        } else {
          return {
                  TAG: "Error",
                  _0: {
                    TAG: "CannotConnectToALS",
                    _0: e$1._0
                  }
                };
        }
      }
      await FS$AgdaModeVscode.$$delete(tempFileUri);
      var genericError = {
        message: "Downloaded file is not a ZIP file. The URL may require authentication or may not be a direct download link."
      };
      return {
              TAG: "Error",
              _0: {
                TAG: "CannotDownloadFromURL",
                _0: {
                  TAG: "CannotReadFile",
                  _0: genericError
                }
              }
            };
    }
    var error$1 = error._0;
    var convertedError;
    if (typeof error$1 !== "object") {
      convertedError = {
        TAG: "CannotReadFile",
        _0: {
          message: "No redirect location"
        }
      };
    } else {
      switch (error$1.TAG) {
        case "Timeout" :
            convertedError = {
              TAG: "CannotReadFile",
              _0: {
                message: "Timeout after " + String(error$1._0) + "ms"
              }
            };
            break;
        case "JsonParseError" :
            convertedError = {
              TAG: "CannotReadFile",
              _0: {
                message: "JSON parse error: " + error$1._0
              }
            };
            break;
        case "ServerResponseError" :
        case "CannotWriteFile" :
            convertedError = {
              TAG: "CannotReadFile",
              _0: error$1._0
            };
            break;
        
      }
    }
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotDownloadFromURL",
              _0: convertedError
            }
          };
  }
  catch (raw_obj){
    var obj = Caml_js_exceptions.internalToOCamlException(raw_obj);
    if (obj.RE_EXN_ID === Js_exn.$$Error) {
      return {
              TAG: "Error",
              _0: {
                TAG: "CannotDownloadFromURL",
                _0: {
                  TAG: "CannotReadFile",
                  _0: obj._1
                }
              }
            };
    }
    var genericError$1 = {
      message: "Invalid URL"
    };
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotDownloadFromURL",
              _0: {
                TAG: "CannotReadFile",
                _0: genericError$1
              }
            }
          };
  }
}

exports.$$Error = $$Error;
exports.makeRepo = makeRepo;
exports.getReleaseManifest = getReleaseManifest;
exports.download = download;
exports.downloadFromURL = downloadFromURL;
/* url Not a pure module */
