// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Nodepath = require("node:path");
var OS$AgdaModeVscode = require("../../Util/OS.bs.js");
var Connection__Process__Exec$AgdaModeVscode = require("../Shared/Connection__Process__Exec.bs.js");

function toString(error) {
  if (typeof error !== "object") {
    if (error === "NotFound") {
      return "Command not found";
    } else {
      return "Internal error";
    }
  } else {
    return Connection__Process__Exec$AgdaModeVscode.$$Error.toString(error._0);
  }
}

var $$Error = {
  toString: toString
};

async function searchWith(command, args, timeoutOpt) {
  var timeout = timeoutOpt !== undefined ? timeoutOpt : 1000;
  var stdout = await Connection__Process__Exec$AgdaModeVscode.run(command, args, timeout, false);
  if (stdout.TAG === "Ok") {
    var path = stdout._0.trim();
    return {
            TAG: "Ok",
            _0: path
          };
  }
  var error = stdout._0;
  if (typeof error !== "object") {
    return {
            TAG: "Error",
            _0: {
              TAG: "SomethingWentWrong",
              _0: error
            }
          };
  }
  if (error.TAG !== "FromStderr") {
    return {
            TAG: "Error",
            _0: {
              TAG: "SomethingWentWrong",
              _0: error
            }
          };
  }
  var match = error._0;
  if (match === undefined) {
    return {
            TAG: "Error",
            _0: {
              TAG: "SomethingWentWrong",
              _0: error
            }
          };
  }
  if (match !== 1) {
    return {
            TAG: "Error",
            _0: {
              TAG: "SomethingWentWrong",
              _0: error
            }
          };
  }
  switch (error._1) {
    case "" :
    case "INFO: Could not find files for the given pattern(s).\r\n" :
        return {
                TAG: "Error",
                _0: "NotFound"
              };
    default:
      return {
              TAG: "Error",
              _0: {
                TAG: "SomethingWentWrong",
                _0: error
              }
            };
  }
}

async function search(name, timeoutOpt) {
  var timeout = timeoutOpt !== undefined ? timeoutOpt : 1000;
  var flakyLookup = function () {
    var retry = async function (n) {
      var result = await searchWith("sh", [
            "-c",
            "command -v -- \"$1\"",
            "--",
            name
          ], timeout);
      if (result.TAG === "Ok" && result._0 === "") {
        if (n > 0) {
          return await retry(n - 1 | 0);
        } else {
          return {
                  TAG: "Error",
                  _0: "InternalError"
                };
        }
      } else {
        return result;
      }
    };
    return retry(3);
  };
  var filterPath = function (result) {
    if (result.TAG !== "Ok") {
      return {
              TAG: "Error",
              _0: result._0
            };
    }
    var trimmed = result._0.trim();
    var hasSeparator = trimmed.includes("/") || trimmed.includes("\\");
    var isAbsolute = Nodepath.isAbsolute(trimmed);
    if (trimmed !== "" && (isAbsolute || hasSeparator)) {
      return {
              TAG: "Ok",
              _0: trimmed
            };
    } else {
      return {
              TAG: "Error",
              _0: "NotFound"
            };
    }
  };
  if (OS$AgdaModeVscode.onUnix) {
    return filterPath(await flakyLookup());
  } else {
    return filterPath(await searchWith("where.exe", [name], timeout));
  }
}

exports.$$Error = $$Error;
exports.searchWith = searchWith;
exports.search = search;
/* node:path Not a pure module */
