// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Js_exn = require("rescript/lib/js/js_exn.js");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Caml_js_exceptions = require("rescript/lib/js/caml_js_exceptions.js");

var createFile = (function(memfs, path, options) {
    memfs.createFile(path, options);
  });

var createFactory = (function(constructor, wasm, mod) { return new constructor(wasm, mod); });

var extractZipToMemfs = (async function(memfs, zipData, createDirectory, createFile) {
    const JSZip = require("jszip");
    const zip = await JSZip.loadAsync(zipData);

    for (const [relativePath, file] of Object.entries(zip.files)) {
      if (file.dir) {
        try {
          createDirectory(memfs, relativePath.slice(0, -1));
        } catch (e) {
          // Directory might already exist
        }
      } else {
        const content = await file.async('uint8array');
        createFile(memfs, relativePath, {
          size: BigInt(content.length),
          reader: () => Promise.resolve(content)
        });
      }
    }
  });

async function downloadStdlib() {
  try {
    var response = await fetch("https://raw.githubusercontent.com/banacorn/agda-library-proxy/master/agda-stdlib-2.3.zip", {
          method: "GET",
          headers: Caml_option.some(new Headers({
                    "User-Agent": "agda-mode-vscode"
                  }))
        });
    if (response.ok) {
      return {
              TAG: "Ok",
              _0: await response.bytes()
            };
    } else {
      return {
              TAG: "Error",
              _0: undefined
            };
    }
  }
  catch (raw_exn){
    var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
    if (exn.RE_EXN_ID === Js_exn.$$Error) {
      return {
              TAG: "Error",
              _0: undefined
            };
    }
    throw exn;
  }
}

async function make(extension, raw) {
  var $$exports = extension.exports;
  var agdaLanguageServerFactory = $$exports.AgdaLanguageServerFactory;
  var wasmAPILoader = $$exports.WasmAPILoader;
  var createUriConverters = $$exports.createUriConverters;
  var wasm = wasmAPILoader.load();
  var mod = await WebAssembly.compile(raw);
  var factory = createFactory(agdaLanguageServerFactory, wasm, mod);
  var memfsAgdaDataDir = await wasm.createMemoryFileSystem();
  var zipData = await downloadStdlib();
  if (zipData.TAG === "Ok") {
    try {
      await extractZipToMemfs(memfsAgdaDataDir, zipData._0, (function (prim0, prim1) {
              prim0.createDirectory(prim1);
            }), createFile);
    }
    catch (raw_exn){
      var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
      if (exn.RE_EXN_ID !== Js_exn.$$Error) {
        throw exn;
      }
      
    }
  }
  var presetupCallback = async function (param) {
    var memfsHome = param.memfsHome;
    try {
      memfsHome.createDirectory(".config");
      memfsHome.createDirectory(".config/agda");
      ((function(memfsHome, createFile) {
          const content = new TextEncoder().encode('/opt/agda/agda-stdlib-2.3/standard-library.agda-lib\n');
          createFile(memfsHome, '.config/agda/libraries', {
            size: BigInt(content.length),
            reader: () => Promise.resolve(content)
          });
        })(memfsHome, createFile));
      return ;
    }
    catch (raw_exn){
      var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
      if (exn.RE_EXN_ID === Js_exn.$$Error) {
        return ;
      }
      throw exn;
    }
  };
  return {
          factory: factory,
          wasm: wasm,
          memfsAgdaDataDir: memfsAgdaDataDir,
          createUriConverters: createUriConverters,
          presetupCallback: presetupCallback
        };
}

exports.createFile = createFile;
exports.createFactory = createFactory;
exports.extractZipToMemfs = extractZipToMemfs;
exports.downloadStdlib = downloadStdlib;
exports.make = make;
/* extractZipToMemfs Not a pure module */
