// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Js_exn = require("rescript/lib/js/js_exn.js");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Caml_js_exceptions = require("rescript/lib/js/caml_js_exceptions.js");
var Util$AgdaModeVscode = require("../../Util/Util.bs.js");

var createFactory = (function(constructor, wasm, mod) { return new constructor(wasm, mod); });

async function prepareAgdaDataDir(extension, memfs) {
  try {
    var response = await fetch("https://github.com/andy0130tw/vscode-als-wasm-loader/releases/download/v0.2.1/agda-data.zip", {
          method: "GET",
          headers: Caml_option.some(new Headers({
                    "User-Agent": "agda-mode-vscode"
                  }))
        });
    if (!response.ok) {
      return {
              TAG: "Error",
              _0: "Failed to fetch agda-data.zip from GitHub: HTTP " + String(response.status)
            };
    }
    var arrayBufferData = await response.arrayBuffer();
    var zipData = new Uint8Array(arrayBufferData);
    var $$exports = extension.exports;
    await $$exports.prepareMemfsFromAgdaDataZip(zipData, memfs);
    return {
            TAG: "Ok",
            _0: Object.fromEntries([[
                    "Agda_datadir",
                    "/opt/agda"
                  ]])
          };
  }
  catch (raw_exn){
    var exn = Caml_js_exceptions.internalToOCamlException(raw_exn);
    if (exn.RE_EXN_ID === Js_exn.$$Error) {
      return {
              TAG: "Error",
              _0: "Failed to download or prepare agda-data.zip"
            };
    }
    throw exn;
  }
}

async function downloadStdlib() {
  var stdlibUrl = "https://raw.githubusercontent.com/banacorn/agda-library-proxy/master/agda-stdlib-2.3.zip";
  Util$AgdaModeVscode.log("[WASMLoader] Starting stdlib download from", stdlibUrl);
  try {
    var response = await fetch(stdlibUrl, {
          method: "GET",
          headers: Caml_option.some(new Headers({
                    "User-Agent": "agda-mode-vscode"
                  }))
        });
    if (response.ok) {
      Util$AgdaModeVscode.log("[WASMLoader] Download successful, converting to Uint8Array", undefined);
      var arrayBufferData = await response.arrayBuffer();
      var zipData = new Uint8Array(arrayBufferData);
      Util$AgdaModeVscode.log("[WASMLoader] Stdlib data ready, size (bytes)", zipData.length);
      return {
              TAG: "Ok",
              _0: zipData
            };
    }
    var errorMsg = "Failed to fetch stdlib: HTTP " + String(response.status);
    Util$AgdaModeVscode.log("[WASMLoader] Download failed", errorMsg);
    return {
            TAG: "Error",
            _0: errorMsg
          };
  }
  catch (raw_err){
    var err = Caml_js_exceptions.internalToOCamlException(raw_err);
    if (err.RE_EXN_ID === Js_exn.$$Error) {
      var errorMsg$1 = "Exception while downloading stdlib: " + Core__Option.getOr(err._1.message, "unknown error");
      Util$AgdaModeVscode.log("[WASMLoader] Download exception", errorMsg$1);
      return {
              TAG: "Error",
              _0: errorMsg$1
            };
    }
    throw err;
  }
}

async function make(extension, raw) {
  var $$exports = extension.exports;
  var agdaLanguageServerFactory = $$exports.AgdaLanguageServerFactory;
  var wasmAPILoader = $$exports.WasmAPILoader;
  var createUriConverters = $$exports.createUriConverters;
  var wasm = wasmAPILoader.load();
  var mod = await WebAssembly.compile(raw);
  var factory = createFactory(agdaLanguageServerFactory, wasm, mod);
  var memfsAgdaDataDir = await wasm.createMemoryFileSystem();
  Util$AgdaModeVscode.log("[WASMLoader] Testing stdlib download...", undefined);
  var data = await downloadStdlib();
  if (data.TAG === "Ok") {
    Util$AgdaModeVscode.log("[WASMLoader] SUCCESS: Downloaded stdlib", data._0.length);
  } else {
    Util$AgdaModeVscode.log("[WASMLoader] ERROR: Failed to download stdlib", data._0);
  }
  return {
          factory: factory,
          wasm: wasm,
          memfsAgdaDataDir: memfsAgdaDataDir,
          createUriConverters: createUriConverters
        };
}

exports.createFactory = createFactory;
exports.prepareAgdaDataDir = prepareAgdaDataDir;
exports.downloadStdlib = downloadStdlib;
exports.make = make;
/* Util-AgdaModeVscode Not a pure module */
