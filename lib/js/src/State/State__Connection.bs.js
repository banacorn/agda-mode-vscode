// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Chan$AgdaModeVscode = require("../Util/Chan.bs.js");
var Config$AgdaModeVscode = require("../Config.bs.js");
var Connection$AgdaModeVscode = require("../Connection/Connection.bs.js");
var State__View$AgdaModeVscode = require("./State__View.bs.js");
var Registry__Connection$AgdaModeVscode = require("../Registry__Connection.bs.js");

async function sendRequest(state, handleResponse, request) {
  var sendRequestAndHandleResponses = async function (connection, state, request, handler) {
    var onResponse = async function (response) {
      await handler(response);
      return Chan$AgdaModeVscode.emit(state.channels.log, {
                  TAG: "ResponseHandled",
                  _0: response
                });
    };
    Chan$AgdaModeVscode.emit(state.channels.log, {
          TAG: "RequestSent",
          _0: request
        });
    var result = await Registry__Connection$AgdaModeVscode.execute(state.id, (function (connection) {
            return Connection$AgdaModeVscode.sendRequest(connection, state.document, request, onResponse);
          }));
    if (result.TAG !== "Ok") {
      return await State__View$AgdaModeVscode.Panel.displayConnectionError(state, result._0);
    }
    await State__View$AgdaModeVscode.Panel.displayConnectionStatus(state, connection);
    switch (connection.TAG) {
      case "Agda" :
          state.agdaVersion = connection._2;
          return ;
      case "ALS" :
          var match = connection._2;
          if (match !== undefined) {
            state.agdaVersion = match[1];
          } else {
            state.agdaVersion = undefined;
          }
          return ;
      case "ALSWASM" :
          var match$1 = connection._3;
          if (match$1 !== undefined) {
            state.agdaVersion = match$1[1];
          } else {
            state.agdaVersion = undefined;
          }
          return ;
      
    }
  };
  var make = function () {
    return Connection$AgdaModeVscode.makeWithFallback(state.platformDeps, state.memento, state.globalStorageUri, Config$AgdaModeVscode.Connection.getAgdaPaths(), [
                "als",
                "agda"
              ], state.channels.log);
  };
  var error = await Registry__Connection$AgdaModeVscode.acquire(state.id, make);
  if (error.TAG === "Ok") {
    return await sendRequestAndHandleResponses(error._0, state, request, handleResponse);
  } else {
    return await State__View$AgdaModeVscode.Panel.displayConnectionError(state, error._0);
  }
}

async function sendRequestAndCollectResponses(state, request) {
  var responses = {
    contents: []
  };
  var responseHandler = async function (response) {
    responses.contents.push(response);
  };
  await sendRequest(state, responseHandler, request);
  return responses.contents;
}

exports.sendRequest = sendRequest;
exports.sendRequestAndCollectResponses = sendRequestAndCollectResponses;
/* Chan-AgdaModeVscode Not a pure module */
