// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Goal$AgdaModeVscode = require("../Goal.bs.js");
var Item$AgdaModeVscode = require("../View/Component/Item.bs.js");
var Common$AgdaModeVscode = require("../View/Common.bs.js");
var Editor$AgdaModeVscode = require("../Editor.bs.js");
var State__View$AgdaModeVscode = require("./State__View.bs.js");

function updateIntervals(state) {
  var indices = state.goals.map(function (goal) {
        return goal.index;
      });
  var diffs = Goal$AgdaModeVscode.generateDiffs(state.document, indices);
  diffs.forEach(function (diff, i) {
        var goal = state.goals[i];
        if (goal !== undefined) {
          goal.interval = diff.modifiedInterval;
          return ;
        }
        
      });
}

async function modify(state, goal, f) {
  updateIntervals(state);
  var content = Goal$AgdaModeVscode.getContent(goal, state.document);
  if (await Goal$AgdaModeVscode.setContent(goal, state.document, f(content))) {
    return updateIntervals(state);
  } else {
    return await State__View$AgdaModeVscode.Panel.display(state, {
                TAG: "Error",
                _0: "Goal-related Error",
                [Symbol.for("name")]: "Error"
              }, [Item$AgdaModeVscode.plainText("Failed to modify the content of goal #" + String(goal.index))]);
  }
}

function pointed(state) {
  updateIntervals(state);
  var cursor = Editor$AgdaModeVscode.Cursor.get(state.editor);
  var cursorOffset = state.document.offsetAt(cursor);
  var pointedGoals = state.goals.filter(function (goal) {
        return Common$AgdaModeVscode.Interval.contains(goal.interval, cursorOffset);
      });
  return Core__Option.map(pointedGoals[0], (function (goal) {
                return [
                        goal,
                        Goal$AgdaModeVscode.getContent(goal, state.document)
                      ];
              }));
}

function redecorate(state) {
  updateIntervals(state);
  state.goals.forEach(function (goal) {
        Goal$AgdaModeVscode.refreshDecoration(goal, state.editor);
      });
}

var Module = {
  modify: modify,
  pointed: pointed,
  redecorate: redecorate
};

exports.Module = Module;
exports.modify = modify;
exports.pointed = pointed;
exports.redecorate = redecorate;
/* Goal-AgdaModeVscode Not a pure module */
