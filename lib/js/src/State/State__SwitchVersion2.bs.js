// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Vscode = require("vscode");
var Caml_obj = require("rescript/lib/js/caml_obj.js");
var Nodepath = require("node:path");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Core__Array = require("@rescript/core/lib/js/src/Core__Array.bs.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Util$AgdaModeVscode = require("../Util/Util.bs.js");
var Memento$AgdaModeVscode = require("../Memento.bs.js");
var Connection__URI$AgdaModeVscode = require("../Connection/Shared/Connection__URI.bs.js");
var Connection__Download$AgdaModeVscode = require("../Connection/Resolver/Connection__Download.bs.js");
var Connection__Endpoint$AgdaModeVscode = require("../Connection/Endpoint/Connection__Endpoint.bs.js");
var State__SwitchVersion$AgdaModeVscode = require("./State__SwitchVersion.bs.js");
var Connection__LatestALS$AgdaModeVscode = require("../Connection/Resolver/Connection__LatestALS.bs.js");

function formatEndpointInfo(filename, endpointInfo, isPicked) {
  var match = endpointInfo.endpoint;
  var match$1 = endpointInfo.error;
  var match$2;
  if (typeof match !== "object") {
    match$2 = match$1 !== undefined ? [
        "$(error) " + filename,
        "Error: " + match$1
      ] : [
        "$(question) " + filename,
        "Unknown executable"
      ];
  } else if (match.TAG === "Agda") {
    var version = match._0;
    match$2 = version !== undefined ? [
        "Agda v" + version,
        ""
      ] : [
        "Agda (version unknown)",
        ""
      ];
  } else {
    var match$3 = match._0;
    match$2 = match$3 !== undefined ? [
        "$(squirrel)  ALS v" + match$3[0] + ", Agda v" + match$3[1],
        ""
      ] : [
        "$(squirrel)  ALS (version unknown)",
        ""
      ];
  }
  var description = isPicked ? "Selected" : match$2[1];
  return [
          match$2[0],
          description
        ];
}

function shouldHaveIcon(endpoint) {
  if (typeof endpoint !== "object" || endpoint.TAG !== "Agda") {
    return false;
  } else {
    return true;
  }
}

function formatEndpoint(filename, entry, isPicked) {
  return formatEndpointInfo(filename, {
              endpoint: entry.endpoint,
              error: entry.error
            }, isPicked);
}

var ItemFormatting = {
  formatEndpointInfo: formatEndpointInfo,
  shouldHaveIcon: shouldHaveIcon,
  formatEndpoint: formatEndpoint
};

function formatEndpoint$1(filename, entry, isPicked) {
  return formatEndpoint(filename, entry, isPicked);
}

function createEndpointItem(path, entry, extensionUri, isPicked) {
  var filename = Nodepath.basename(path);
  var match = formatEndpoint$1(filename, entry, isPicked);
  var iconPath = shouldHaveIcon(entry.endpoint) ? ({
        dark: Vscode.Uri.joinPath(extensionUri, "asset/dark.png"),
        light: Vscode.Uri.joinPath(extensionUri, "asset/light.png")
      }) : undefined;
  var baseItem_description = match[1];
  var baseItem_detail = path;
  var baseItem_label = match[0];
  var baseItem = {
    description: baseItem_description,
    detail: baseItem_detail,
    label: baseItem_label
  };
  if (iconPath === undefined) {
    return baseItem;
  }
  var newrecord = Caml_obj.obj_dup(baseItem);
  newrecord.iconPath = Caml_option.some(Caml_option.valFromOption(iconPath));
  return newrecord;
}

function createSeparatorItem(label) {
  return {
          kind: -1,
          label: label
        };
}

function createNoInstallationsItem() {
  return {
          description: "Try installing Agda or ALS first",
          detail: "No executable paths detected",
          label: "$(info) No installations found"
        };
}

function createOpenFolderItem(globalStorageUri) {
  return {
          description: "Where the language servers are downloaded to",
          detail: globalStorageUri.fsPath,
          label: "$(folder-opened)  Open download folder"
        };
}

function createDownloadItem(downloaded, versionString) {
  return {
          description: downloaded ? "Downloaded and installed" : "",
          detail: versionString,
          label: "$(cloud-download)  Download the latest Agda Language Server"
        };
}

var ItemCreation = {
  formatEndpoint: formatEndpoint$1,
  createEndpointItem: createEndpointItem,
  createSeparatorItem: createSeparatorItem,
  createNoInstallationsItem: createNoInstallationsItem,
  createOpenFolderItem: createOpenFolderItem,
  createDownloadItem: createDownloadItem
};

function make() {
  return {
          quickPick: Vscode.window.createQuickPick(),
          subscriptions: [],
          items: []
        };
}

function setPlaceholder(self, placeholder) {
  self.quickPick.placeholder = placeholder;
}

function updateItems(self, items) {
  self.items = items;
  self.quickPick.items = items;
}

function show(self) {
  self.quickPick.show();
}

function onSelection(self, handler) {
  Util$AgdaModeVscode.Disposable.add(self.quickPick.onDidChangeSelection(handler), self.subscriptions);
}

function onHide(self, handler) {
  Util$AgdaModeVscode.Disposable.add(self.quickPick.onDidHide(handler), self.subscriptions);
}

function destroy(self) {
  self.quickPick.dispose();
  self.subscriptions.forEach(function (sub) {
        sub.dispose();
      });
}

var QuickPickManager = {
  make: make,
  setPlaceholder: setPlaceholder,
  updateItems: updateItems,
  show: show,
  onSelection: onSelection,
  onHide: onHide,
  destroy: destroy
};

function getPickedPath(memento) {
  return Memento$AgdaModeVscode.Module.PickedConnection.get(memento);
}

function entriesToItems(entries, extensionUri, globalStorageUri, pickedPath, downloadItem, param) {
  var pathItems = Object.entries(entries).map(function (param) {
        var path = param[0];
        var isPicked = pickedPath !== undefined ? pickedPath === path : false;
        return createEndpointItem(path, param[1], extensionUri, isPicked);
      });
  var installedSection = pathItems.length > 0 ? [{
          kind: -1,
          label: "Installed"
        }].concat(pathItems) : [{
        description: "Try installing Agda or ALS first",
        detail: "No executable paths detected",
        label: "$(info) No installations found"
      }];
  var downloadSection = downloadItem !== undefined ? [
      {
        kind: -1,
        label: "Download"
      },
      downloadItem
    ] : [];
  var miscSection = [
    {
      kind: -1,
      label: "Misc"
    },
    createOpenFolderItem(globalStorageUri)
  ];
  return [
            installedSection,
            downloadSection,
            miscSection
          ].flat();
}

function getPathsNeedingProbe(entries) {
  return Core__Array.filterMap(Object.entries(entries), (function (param) {
                var match = param[1].endpoint;
                if (typeof match !== "object") {
                  return ;
                }
                match.TAG === "Agda";
                if (match._0 !== undefined) {
                  return ;
                } else {
                  return param[0];
                }
              }));
}

function entriesChanged(oldEntries, newEntries) {
  return newEntries !== oldEntries;
}

var EndpointLogic = {
  getPickedPath: getPickedPath,
  entriesToItems: entriesToItems,
  getPathsNeedingProbe: getPathsNeedingProbe,
  entriesChanged: entriesChanged
};

function make$1(state) {
  return {
          entries: Memento$AgdaModeVscode.Module.Endpoints.entries(state.memento),
          extensionUri: state.extensionUri
        };
}

function toItems(self, memento, globalStorageUri, downloadItem, param) {
  var pickedPath = getPickedPath(memento);
  return entriesToItems(self.entries, self.extensionUri, globalStorageUri, pickedPath, downloadItem, undefined);
}

function updateItems$1(self, qp, memento, globalStorageUri, downloadItem, param) {
  var items = toItems(self, memento, globalStorageUri, downloadItem, undefined);
  updateItems(qp, items);
}

function refreshFromMemento(self, memento) {
  var newEntries = Memento$AgdaModeVscode.Module.Endpoints.entries(memento);
  var changed = newEntries !== self.entries;
  if (changed) {
    self.entries = newEntries;
  }
  return changed;
}

async function syncWithFilesystem(self, state, platformDeps) {
  var discoveredEndpoints = await platformDeps.getInstalledEndpointsAndPersistThem2(state.globalStorageUri);
  await Memento$AgdaModeVscode.Module.Endpoints.syncWithPaths(state.memento, discoveredEndpoints);
  return refreshFromMemento(self, state.memento);
}

async function probeVersions(self, state) {
  var pathsToProbe = getPathsNeedingProbe(self.entries);
  if (pathsToProbe.length === 0) {
    return false;
  }
  var probePromises = pathsToProbe.map(async function (path) {
        var uri = Connection__URI$AgdaModeVscode.parse(path);
        var error = await Connection__Endpoint$AgdaModeVscode.probeFilepath(uri);
        if (error.TAG === "Ok") {
          var match = error._0;
          if (match.TAG === "Agda") {
            await Memento$AgdaModeVscode.Module.Endpoints.setVersion(state.memento, path, {
                  TAG: "Agda",
                  _0: match._0
                });
            return path;
          }
          await Memento$AgdaModeVscode.Module.Endpoints.setVersion(state.memento, path, {
                TAG: "ALS",
                _0: [
                  match._0,
                  match._1
                ]
              });
          return path;
        }
        await Memento$AgdaModeVscode.Module.Endpoints.setError(state.memento, path, Connection__Endpoint$AgdaModeVscode.$$Error.toString(error._0));
        return path;
      });
  var updateResults = await Promise.all(probePromises);
  var updatedPaths = Core__Array.filterMap(updateResults, (function (x) {
          return x;
        }));
  if (updatedPaths.length > 0) {
    refreshFromMemento(self, state.memento);
    return true;
  } else {
    return false;
  }
}

var EndpointManager = {
  make: make$1,
  toItems: toItems,
  updateItems: updateItems$1,
  refreshFromMemento: refreshFromMemento,
  syncWithFilesystem: syncWithFilesystem,
  probeVersions: probeVersions
};

async function createDownloadItem$1(state, platformDeps) {
  var platform = await platformDeps.determinePlatform();
  if (platform.TAG !== "Ok") {
    return ;
  }
  var fetchSpec = await Connection__LatestALS$AgdaModeVscode.getFetchSpec(state.memento, state.globalStorageUri, platform._0);
  if (fetchSpec.TAG !== "Ok") {
    return ;
  }
  var fetchSpec$1 = fetchSpec._0;
  var installedEndpoints = await platformDeps.getInstalledEndpointsAndPersistThem(state.globalStorageUri);
  var installedPaths = Core__Array.filterMap(Object.values(installedEndpoints), (function (x) {
          if (x.TAG === "Ok") {
            return Connection__URI$AgdaModeVscode.toString(Connection__Endpoint$AgdaModeVscode.toURI(x._0));
          }
          
        }));
  var filename = Nodepath.join(state.globalStorageUri.fsPath, fetchSpec$1.saveAsFileName, "als");
  var filenameAsUri = Vscode.Uri.file(filename).toString();
  var downloaded = installedPaths.includes(filenameAsUri);
  var getAgdaVersion = function (asset) {
    return asset.name.replace(/als-Agda-/, "").replace(/-.*/, "");
  };
  var agdaVersion = getAgdaVersion(fetchSpec$1.asset);
  var alsVersion = Core__Option.getOr(Core__Array.last(fetchSpec$1.release.name.split(".")), fetchSpec$1.release.name);
  var versionString = State__SwitchVersion$AgdaModeVscode.VersionDisplay.formatALSVersion(alsVersion, agdaVersion);
  return createDownloadItem(downloaded, versionString);
}

async function run(state, platformDeps) {
  var qp = make();
  var endpointManager = make$1(state);
  setPlaceholder(qp, "Switch Version");
  updateItems$1(endpointManager, qp, state.memento, state.globalStorageUri, undefined, undefined);
  qp.quickPick.show();
  var downloadItemPromise = createDownloadItem$1(state, platformDeps);
  onSelection(qp, (function (selectedItems) {
          destroy(qp);
          ((async function () {
                  var selectedItem = selectedItems[0];
                  if (selectedItem === undefined) {
                    return ;
                  }
                  if (selectedItem.label === "$(folder-opened)  Open download folder") {
                    var globalStorageUriAsFile = Vscode.Uri.file(state.globalStorageUri.fsPath);
                    await Vscode.env.openExternal(globalStorageUriAsFile);
                    return ;
                  }
                  if (selectedItem.label === "$(cloud-download)  Download the latest Agda Language Server") {
                    var item = await createDownloadItem$1(state, platformDeps);
                    if (item !== undefined) {
                      var match = item.description;
                      var alreadyDownloaded = match === "Downloaded and installed" ? true : false;
                      if (alreadyDownloaded) {
                        await Vscode.window.showInformationMessage(Core__Option.getOr(item.detail, "ALS") + " is already downloaded");
                        return ;
                      }
                      var platform = await platformDeps.determinePlatform();
                      if (platform.TAG === "Ok") {
                        var error = await platformDeps.downloadLatestALS(state.memento, state.globalStorageUri)(platform._0);
                        if (error.TAG === "Ok") {
                          var newDownloadItem = await createDownloadItem$1(state, platformDeps);
                          updateItems$1(endpointManager, qp, state.memento, state.globalStorageUri, newDownloadItem, undefined);
                          await Vscode.window.showInformationMessage(Core__Option.getOr(item.detail, "ALS") + " successfully downloaded");
                          return ;
                        }
                        await Vscode.window.showErrorMessage(Connection__Download$AgdaModeVscode.$$Error.toString(error._0));
                        return ;
                      }
                      await Vscode.window.showErrorMessage("Failed to determine platform");
                      return ;
                    }
                    await Vscode.window.showErrorMessage("Download not available for this platform");
                    return ;
                  }
                  var selectedPath = selectedItem.detail;
                  if (selectedPath !== undefined) {
                    Memento$AgdaModeVscode.Module.PickedConnection.set(state.memento, selectedPath);
                    return ;
                  }
                  
                })());
        }));
  onHide(qp, (function () {
          destroy(qp);
        }));
  var backgroundUpdate = async function () {
    try {
      var downloadItem = await downloadItemPromise;
      var phase2Changed = await syncWithFilesystem(endpointManager, state, platformDeps);
      if (phase2Changed) {
        updateItems$1(endpointManager, qp, state.memento, state.globalStorageUri, downloadItem, undefined);
      }
      var phase3Changed = await probeVersions(endpointManager, state);
      if (phase3Changed) {
        updateItems$1(endpointManager, qp, state.memento, state.globalStorageUri, downloadItem, undefined);
      }
      if (!phase2Changed && !phase3Changed) {
        return updateItems$1(endpointManager, qp, state.memento, state.globalStorageUri, downloadItem, undefined);
      } else {
        return ;
      }
    }
    catch (_exn){
      return ;
    }
  };
  backgroundUpdate();
}

exports.ItemFormatting = ItemFormatting;
exports.ItemCreation = ItemCreation;
exports.QuickPickManager = QuickPickManager;
exports.EndpointLogic = EndpointLogic;
exports.EndpointManager = EndpointManager;
exports.createDownloadItem = createDownloadItem$1;
exports.run = run;
/* vscode Not a pure module */
