// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Goal$AgdaModeVscode = require("./Goal.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");
var Event$AgdaModeVscode = require("./Util/Event.bs.js");
var Request$AgdaModeVscode = require("./Request.bs.js");
var Connection$AgdaModeVscode = require("./Connection.bs.js");
var InputMethod$AgdaModeVscode = require("./InputMethod.bs.js");

function Impl(Editor) {
  var Goal = Goal$AgdaModeVscode.Impl(Editor);
  var InputMethod = InputMethod$AgdaModeVscode.Impl(Editor);
  var $$Request = Request$AgdaModeVscode.Impl(Editor);
  var getEditor = function (state) {
    return state.editor;
  };
  var onceDestroyed = function (state) {
    return Curry._1(state.onDestroyEventEmitter.once, undefined);
  };
  var connect = function (state) {
    var connection = state.connection;
    if (connection !== undefined) {
      return $$Promise.resolved(/* Ok */Caml_chrome_debugger.variant("Ok", 0, [connection]));
    } else {
      return $$Promise.tapOk($$Promise.mapError(Connection$AgdaModeVscode.make(Editor.Config.getAgdaPath, Editor.Config.setAgdaPath), (function (e) {
                        return /* Connection */Caml_chrome_debugger.variant("Connection", 0, [e]);
                      })), (function (conn) {
                    state.connection = conn;
                    
                  }));
    }
  };
  var disconnect = function (state) {
    var connection = state.connection;
    if (connection !== undefined) {
      Connection$AgdaModeVscode.destroy(connection);
      return $$Promise.resolved(undefined);
    } else {
      return $$Promise.resolved(undefined);
    }
  };
  var sendRequestToAgda = function (state, request) {
    return $$Promise.mapOk(connect(state), (function (connection) {
                  var version = connection.metadata.version;
                  var filepath = Belt_Option.getWithDefault(Curry._1(Editor.getFileName, state.editor), "");
                  var libraryPath = Curry._1(Editor.Config.getLibraryPath, undefined);
                  var highlightingMethod = Curry._1(Editor.Config.getHighlightingMethod, undefined);
                  var encoded = Curry._6($$Request.encode, state.editor, version, filepath, libraryPath, highlightingMethod, request);
                  console.log("<<<", encoded);
                  Connection$AgdaModeVscode.send(encoded, connection);
                  return connection;
                }));
  };
  var setLoaded = function (value) {
    Curry._2(Editor.setContext, "agdaMode", value);
    
  };
  var destroy = function (state) {
    Curry._1(Editor.View.destroy, state.view);
    Curry._1(state.onDestroyEventEmitter.emit, undefined);
    Curry._1(state.onDestroyEventEmitter.destroy, undefined);
    Belt_Array.forEach(state.goals, Goal.destroy);
    Curry._2(Editor.setContext, "agdaMode", false);
    return disconnect(state);
  };
  var make = function (context, editor) {
    Curry._2(Editor.setContext, "agdaMode", true);
    var view = Curry._2(Editor.View.make, context, editor);
    return {
            editor: editor,
            context: context,
            view: view,
            connection: undefined,
            goals: [],
            cursor: undefined,
            onDestroyEventEmitter: Event$AgdaModeVscode.make(undefined),
            inputMethod: Curry._1(InputMethod.make, undefined)
          };
  };
  var show = function (state) {
    Curry._1(Editor.View.show, state.view);
    Curry._2(Editor.setContext, "agdaMode", true);
    
  };
  var hide = function (state) {
    Curry._1(Editor.View.hide, state.view);
    Curry._2(Editor.setContext, "agdaMode", false);
    
  };
  var sendRequestToView = function (state, request) {
    return Curry._2(Editor.View.send, state.view, request);
  };
  return {
          Goal: Goal,
          InputMethod: InputMethod,
          $$Request: $$Request,
          getEditor: getEditor,
          onceDestroyed: onceDestroyed,
          connect: connect,
          disconnect: disconnect,
          sendRequestToAgda: sendRequestToAgda,
          setLoaded: setLoaded,
          destroy: destroy,
          make: make,
          show: show,
          hide: hide,
          sendRequestToView: sendRequestToView
        };
}

exports.Impl = Impl;
/* Promise Not a pure module */
