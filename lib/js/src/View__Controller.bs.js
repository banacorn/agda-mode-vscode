// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Path = require("path");
var Curry = require("bs-platform/lib/js/curry.js");
var Vscode = require("vscode");
var Js_math = require("bs-platform/lib/js/js_math.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Caml_js_exceptions = require("bs-platform/lib/js/caml_js_exceptions.js");
var View$AgdaModeVscode = require("./View.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");
var Event$AgdaModeVscode = require("./Util/Event.bs.js");
var VSCode$AgdaModeVscode = require("./VSCode.bs.js");

function send(view, req) {
  var queued = view.status;
  if (queued) {
    var match = $$Promise.pending(undefined);
    queued[0].push(/* tuple */[
          req,
          match[1]
        ]);
    return match[0];
  }
  if (typeof req === "number" && req >= 2) {
    console.log("FOCUS");
    VSCode$AgdaModeVscode.WebviewPanel.reveal(view.panel, undefined, undefined, undefined);
  }
  var stringified = JSON.stringify(View$AgdaModeVscode.$$Request.encode(req));
  var promise = Curry._1(view.onResponse.once, undefined);
  return $$Promise.flatMap(view.panel.webview.postMessage(stringified), (function (param) {
                return promise;
              }));
}

function on(view, callback) {
  return new Vscode.Disposable(Curry._1(view.onResponse.on, (function ($$event) {
                    if (typeof $$event === "number" || !$$event.tag) {
                      return ;
                    } else {
                      return Curry._1(callback, $$event[0]);
                    }
                  })));
}

function make(getExtensionPath, context, editor) {
  var html = function (distPath, styleUri, scriptUri) {
    var text = "";
    var charaterSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    var cardinality = charaterSet.length;
    for(var _for = 0; _for <= 32; ++_for){
      text = text + charaterSet.charAt(Js_math.floor(Math.random() * cardinality));
    }
    var nonce = text;
    var styleUri$1 = Vscode.Uri.file(Path.join(distPath, styleUri)).with(VSCode$AgdaModeVscode.Uri.makeChange(undefined, undefined, undefined, undefined, "vscode-resource", undefined));
    var scriptUri$1 = Vscode.Uri.file(Path.join(distPath, scriptUri)).with(VSCode$AgdaModeVscode.Uri.makeChange(undefined, undefined, undefined, undefined, "vscode-resource", undefined));
    var metaContent = "default-src 'none'; img-src vscode-resource: https:; script-src 'nonce-" + (nonce + "';style-src vscode-resource: 'unsafe-inline' http: https: data:;");
    return "\n        <!DOCTYPE html>\n              <html lang=\"en\">\n              <head>\n                <meta charset=\"utf-8\">\n                <meta name=\"viewport\" content=\"width=device-width,initial-scale=1,shrink-to-fit=no\">\n                <meta name=\"theme-color\" content=\"#000000\">\n                <title>React App</title>\n                <link rel=\"stylesheet\" type=\"text/css\" href=\"" + (String(styleUri$1) + ("\">\n                <meta http-equiv=\"Content-Security-Policy\" content=\"" + (String(metaContent) + ("\">\n              </head>\n              <body>\n                <noscript>You need to enable JavaScript to run this app.</noscript>\n                <div id=\"root\"></div>\n                <script nonce=\"" + (String(nonce) + ("\" src=\"" + (String(scriptUri$1) + "\"></script>\n              </body>\n              </html>\n        ")))))));
  };
  var createPanel = function (context, editor) {
    var distPath = Path.join(Curry._1(getExtensionPath, context), "dist");
    var fileName = Path.basename(editor.document.fileName, ".agda");
    var panel = Vscode.window.createWebviewPanel("panel", "Agda [" + (fileName + "]"), {
          preserveFocus: true,
          viewColumn: 3
        }, VSCode$AgdaModeVscode.WebviewAndWebviewPanelOptions.make(undefined, true, [Vscode.Uri.file(distPath)], undefined, undefined, true, undefined));
    panel.webview.html = html(distPath, "style.css", "view.bundle.js");
    return panel;
  };
  var moveToBottom = function (param) {
    return Vscode.commands.executeCommand("vscode.setEditorLayout", {
                orientation: 1,
                groups: [
                  Curry._1(VSCode$AgdaModeVscode.Commands.Layout.sized, {
                        groups: [VSCode$AgdaModeVscode.Commands.Layout.simple],
                        size: 0.5
                      }),
                  Curry._1(VSCode$AgdaModeVscode.Commands.Layout.sized, {
                        groups: [VSCode$AgdaModeVscode.Commands.Layout.simple],
                        size: 0.5
                      })
                ]
              });
  };
  var panel = createPanel(context, editor);
  moveToBottom(undefined);
  var onResponse = Event$AgdaModeVscode.make(undefined);
  context.subscriptions.push(panel.webview.onDidReceiveMessage((function (json) {
              var result;
              try {
                result = Curry._1(View$AgdaModeVscode.$$Response.decode, json);
              }
              catch (raw_e){
                var e = Caml_js_exceptions.internalToOCamlException(raw_e);
                console.log("[ panic ][ Webview.onDidReceiveMessage JSON decode error ]", e);
                return ;
              }
              return Curry._1(onResponse.emit, result);
            })));
  context.subscriptions.push(panel.onDidDispose((function (param) {
              return Curry._1(onResponse.emit, /* Event */Caml_chrome_debugger.variant("Event", 1, [/* Destroyed */1]));
            })));
  var view = {
    panel: panel,
    onResponse: onResponse,
    status: /* Uninitialized */Caml_chrome_debugger.simpleVariant("Uninitialized", [[]])
  };
  context.subscriptions.push(new Vscode.Disposable(Curry._1(view.onResponse.on, (function (param) {
                  if (typeof param === "number") {
                    return ;
                  }
                  if (!param.tag) {
                    return ;
                  }
                  if (param[0]) {
                    return ;
                  }
                  var queued = view.status;
                  if (queued) {
                    view.status = /* Initialized */0;
                    return Belt_Array.forEach(queued[0], (function (param) {
                                  return $$Promise.get(send(view, param[0]), param[1]);
                                }));
                  }
                  
                }))));
  return view;
}

function destroy(view) {
  view.panel.dispose();
  return Curry._1(view.onResponse.destroy, undefined);
}

function show(view) {
  return VSCode$AgdaModeVscode.WebviewPanel.reveal(view.panel, undefined, true, undefined);
}

function hide(_view) {
  
}

exports.send = send;
exports.on = on;
exports.make = make;
exports.destroy = destroy;
exports.show = show;
exports.hide = hide;
/* path Not a pure module */
