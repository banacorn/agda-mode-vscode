// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var VSCode = require("rescript-vscode/lib/js/src/VSCode.bs.js");
var Vscode = require("vscode");
var Js_array = require("rescript/lib/js/js_array.js");
var Nodepath = require("node:path");
var PervasivesU = require("rescript/lib/js/pervasivesU.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Chan$AgdaModeVscode = require("../Util/Chan.bs.js");
var Util$AgdaModeVscode = require("../Util/Util.bs.js");
var View$AgdaModeVscode = require("./View.bs.js");
var Json$JsonCombinators = require("@glennsl/rescript-json-combinators/lib/js/src/Json.bs.js");
var Config$AgdaModeVscode = require("../Config.bs.js");

function makeHTML(webview, extensionPath) {
  console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - STARTING ===");
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - extensionPath:", extensionPath);
  var extensionUri = Vscode.Uri.file(extensionPath);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - extensionUri:", extensionUri);
  try {
    var $$location = window.location;
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - window.location.href:", $$location.href);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - window.location.origin:", $$location.origin);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - window.location.hostname:", $$location.hostname);
  }
  catch (exn){
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - window not available (extension context)");
  }
  var text = "";
  var charaterSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  var cardinality = charaterSet.length;
  for(var _for = 0; _for <= 32; ++_for){
    text = text + charaterSet.charAt(Math.floor(Math.random() * cardinality) | 0);
  }
  var nonce = text;
  console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - ENVIRONMENT DETECTION ===");
  var startsWithStatic = extensionPath.startsWith("/static");
  var includesGitHubDev = extensionPath.includes("github.dev");
  var includesVscodeCdn = extensionPath.includes("vscode-cdn");
  var includesDevExtensions = extensionPath.includes("devextensions");
  var cspSourceUri = webview.cspSource;
  var cspIncludesGitHubCdn = cspSourceUri.includes("vscode-unpkg.net") || cspSourceUri.includes("github.dev");
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - startsWithStatic:", startsWithStatic);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - includesGitHubDev:", includesGitHubDev);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - includesVscodeCdn:", includesVscodeCdn);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - includesDevExtensions:", includesDevExtensions);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - cspSourceUri:", cspSourceUri);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - cspIncludesGitHubCdn:", cspIncludesGitHubCdn);
  var isGitHubDev = includesGitHubDev || includesVscodeCdn || cspIncludesGitHubCdn;
  var isWeb = startsWithStatic || isGitHubDev;
  var isAnyWebEnvironment = isWeb || cspSourceUri.includes("vscode-");
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL isLocalWeb:", startsWithStatic);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL isGitHubDev:", isGitHubDev);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL isWeb:", isWeb);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL isAnyWebEnvironment:", isAnyWebEnvironment);
  var match;
  if (startsWithStatic) {
    console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - LOCAL WEB PATH ===");
    var baseUrl = "http://localhost:3000/static/devextensions/dist/";
    var scriptUri = baseUrl + "bundled-view.js";
    var styleUri = baseUrl + "style.css";
    var codiconsUri = baseUrl + "codicon/codicon.css";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL baseUrl:", baseUrl);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL scriptUri:", scriptUri);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL styleUri:", styleUri);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL codiconsUri:", codiconsUri);
    match = [
      scriptUri,
      styleUri,
      codiconsUri
    ];
  } else if (isGitHubDev) {
    console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - GITHUB.DEV PATH ===");
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev extensionPath:", extensionPath);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev extensionUri:", extensionUri);
    var cspParts = cspSourceUri.split(" ");
    var cdnBaseUrl = Core__Option.getOr(cspParts[0], "");
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - CSP parts:", cspParts);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev extracted CDN base URL:", cdnBaseUrl);
    var normalizedCdnUrl = cdnBaseUrl.endsWith("/") ? cdnBaseUrl : cdnBaseUrl + "/";
    var finalCdnUrl = normalizedCdnUrl.length > 10 && normalizedCdnUrl.includes("https://") ? normalizedCdnUrl : (console.log("[AGDA-MODE] WebviewPanel.makeHTML - CSP parsing failed, trying fallback..."), "https://banacorn.vscode-unpkg.net" + extensionPath + "/");
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL CDN base URL:", finalCdnUrl);
    var scriptUri$1 = finalCdnUrl + "dist/bundled-view.js";
    var styleUri$1 = finalCdnUrl + "dist/style.css";
    var codiconsUri$1 = finalCdnUrl + "dist/codicon/codicon.css";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev DIRECT scriptUri:", scriptUri$1);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev DIRECT styleUri:", styleUri$1);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GitHub.dev DIRECT codiconsUri:", codiconsUri$1);
    match = [
      scriptUri$1,
      styleUri$1,
      codiconsUri$1
    ];
  } else {
    console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - DESKTOP PATH ===");
    var scriptPath = Vscode.Uri.joinPath(extensionUri, "dist", "bundled-view.js");
    var stylePath = Vscode.Uri.joinPath(extensionUri, "dist", "style.css");
    var codiconsPath = Vscode.Uri.joinPath(extensionUri, "dist", "codicon/codicon.css");
    var scriptUri$2 = webview.asWebviewUri(scriptPath).toString();
    var styleUri$2 = webview.asWebviewUri(stylePath).toString();
    var codiconsUri$2 = webview.asWebviewUri(codiconsPath).toString();
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP scriptUri:", scriptUri$2);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP styleUri:", styleUri$2);
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP codiconsUri:", codiconsUri$2);
    match = [
      scriptUri$2,
      styleUri$2,
      codiconsUri$2
    ];
  }
  var codiconsUri$3 = match[2];
  var styleUri$3 = match[1];
  var scriptUri$3 = match[0];
  console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - FINAL URIS ===");
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL scriptUri:", scriptUri$3);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL styleUri:", styleUri$3);
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL codiconsUri:", codiconsUri$3);
  var cspSourceUri$1 = webview.cspSource;
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - cspSourceUri:", cspSourceUri$1);
  console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - CSP GENERATION ===");
  var scriptSrc;
  if (startsWithStatic) {
    var src = "script-src 'nonce-" + nonce + "' http://localhost:3000; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL scriptSrc:", src);
    scriptSrc = src;
  } else if (isGitHubDev) {
    var src$1 = "script-src 'nonce-" + nonce + "' https://*.github.dev https://*.vscode-cdn.net https://*.vscode-unpkg.net; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GITHUB.DEV scriptSrc:", src$1);
    scriptSrc = src$1;
  } else {
    var src$2 = "script-src 'nonce-" + nonce + "'; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP scriptSrc:", src$2);
    scriptSrc = src$2;
  }
  var styleSrc;
  if (startsWithStatic) {
    var src$3 = "style-src " + cspSourceUri$1 + " http://localhost:3000; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL styleSrc:", src$3);
    styleSrc = src$3;
  } else if (isGitHubDev) {
    var src$4 = "style-src " + cspSourceUri$1 + " https://*.github.dev https://*.vscode-cdn.net https://*.vscode-unpkg.net; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GITHUB.DEV styleSrc:", src$4);
    styleSrc = src$4;
  } else {
    var src$5 = "style-src " + cspSourceUri$1 + "; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP styleSrc:", src$5);
    styleSrc = src$5;
  }
  var fontSrc;
  if (startsWithStatic) {
    var src$6 = "font-src " + cspSourceUri$1 + " http://localhost:3000; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - LOCAL fontSrc:", src$6);
    fontSrc = src$6;
  } else if (isGitHubDev) {
    var src$7 = "font-src " + cspSourceUri$1 + " https://*.github.dev https://*.vscode-cdn.net https://*.vscode-unpkg.net; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - GITHUB.DEV fontSrc:", src$7);
    fontSrc = src$7;
  } else {
    var src$8 = "font-src " + cspSourceUri$1 + "; ";
    console.log("[AGDA-MODE] WebviewPanel.makeHTML - DESKTOP fontSrc:", src$8);
    fontSrc = src$8;
  }
  var scp = "default-src 'none'; " + fontSrc + scriptSrc + styleSrc;
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - FINAL CSP:", scp);
  var html = "\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width,initial-scale=1,shrink-to-fit=no\">\n        <meta name=\"theme-color\" content=\"#000000\">\n\n        <!--\n					Use a content security policy to only allow loading images from https or from our extension directory,\n					and only allow scripts that have a specific nonce.\n				-->\n        <meta http-equiv=\"Content-Security-Policy\" content=\"" + scp + "\">\n\n        <title>React App</title>\n        <link href=\"" + styleUri$3 + "\"    rel=\"stylesheet\" type=\"text/css\" >\n        <link href=\"" + codiconsUri$3 + "\" rel=\"stylesheet\" />\n      </head>\n      <body>\n        <noscript>You need to enable JavaScript to run this app.</noscript>\n        <div id=\"root\"></div>\n        <script nonce=\"" + nonce + "\" src=\"" + scriptUri$3 + "\"></script>\n        \n        <!-- Debug info embedded in HTML -->\n        <script>\n          console.log(\"[AGDA-MODE] HTML - Environment Detection:\");\n          console.log(\"[AGDA-MODE] HTML - extensionPath: " + extensionPath + "\");\n          console.log(\"[AGDA-MODE] HTML - isLocalWeb: " + PervasivesU.string_of_bool(startsWithStatic) + "\");\n          console.log(\"[AGDA-MODE] HTML - isGitHubDev: " + PervasivesU.string_of_bool(isGitHubDev) + "\");\n          console.log(\"[AGDA-MODE] HTML - scriptUri: " + scriptUri$3 + "\");\n          console.log(\"[AGDA-MODE] HTML - styleUri: " + styleUri$3 + "\");\n          console.log(\"[AGDA-MODE] HTML - codiconsUri: " + codiconsUri$3 + "\");\n          console.log(\"[AGDA-MODE] HTML - CSP: " + scp + "\");\n        </script>\n      </body>\n      </html>\n    ";
  console.log("=== [AGDA-MODE] WebviewPanel.makeHTML - HTML GENERATION COMPLETE ===");
  console.log("[AGDA-MODE] WebviewPanel.makeHTML - Generated HTML preview (first 500 chars):", html.substring(0, 500));
  return html;
}

function make(title, extensionPath) {
  console.log("=== [AGDA-MODE] WebviewPanel.make - STARTING ===");
  console.log("[AGDA-MODE] WebviewPanel.make - title:", title);
  console.log("[AGDA-MODE] WebviewPanel.make - extensionPath:", extensionPath);
  var distPath = Nodepath.join(extensionPath, "dist");
  var distUri = Vscode.Uri.file(distPath);
  console.log("[AGDA-MODE] WebviewPanel.make - distPath:", distPath);
  console.log("[AGDA-MODE] WebviewPanel.make - distUri:", distUri);
  var webviewOptions = VSCode.WebviewAndWebviewPanelOptions.make(undefined, true, [distUri], undefined, undefined, true, undefined);
  console.log("[AGDA-MODE] WebviewPanel.make - webviewOptions:", webviewOptions);
  var panel = Vscode.window.createWebviewPanel("panel", title, {
        preserveFocus: true,
        viewColumn: 3
      }, webviewOptions);
  console.log("[AGDA-MODE] WebviewPanel.make - panel created:", panel);
  console.log("[AGDA-MODE] WebviewPanel.make - panel.webview:", panel.webview);
  console.log("[AGDA-MODE] WebviewPanel.make - About to call makeHTML...");
  var html = makeHTML(panel.webview, extensionPath);
  console.log("[AGDA-MODE] WebviewPanel.make - Generated HTML length:", html.length);
  console.log("[AGDA-MODE] WebviewPanel.make - Setting HTML on webview...");
  panel.webview.html = html;
  console.log("=== [AGDA-MODE] WebviewPanel.make - COMPLETED ===");
  return panel;
}

function destroy(prim) {
  return prim.dispose();
}

function send(panel, message) {
  return panel.webview.postMessage(message);
}

function recv(panel, callback) {
  return panel.webview.onDidReceiveMessage(callback);
}

function onDestroyed(panel, callback) {
  return panel.onDidDispose(callback);
}

function reveal(panel) {
  panel.reveal(undefined, true);
}

function moveToBottom() {
  Vscode.commands.executeCommand((function () {
            switch (({
                  NAME: "setEditorLayout",
                  VAL: {
          orientation: 1,
          groups: [{ size: 0.7 }, { size: 0.3 }]
        }
                }).NAME) {
              case "setEditorLayout" :
                  return "vscode.setEditorLayout";
              case "setContext" :
                  return "setContext";
              
            }
          })(), ({
          NAME: "setEditorLayout",
          VAL: {
          orientation: 1,
          groups: [{ size: 0.7 }, { size: 0.3 }]
        }
        }).VAL);
}

function moveToRight() {
  Vscode.commands.executeCommand((function () {
            switch (({
                  NAME: "setEditorLayout",
                  VAL: {
          orientation: 0,
          groups: [ {size: 0.5}, {size: 0.5} ]
        }
                }).NAME) {
              case "setEditorLayout" :
                  return "vscode.setEditorLayout";
              case "setContext" :
                  return "setContext";
              
            }
          })(), ({
          NAME: "setEditorLayout",
          VAL: {
          orientation: 0,
          groups: [ {size: 0.5}, {size: 0.5} ]
        }
        }).VAL);
}

async function getEditorLayout() {
  return await Vscode.commands.executeCommand("vscode.getEditorLayout");
}

var WebviewPanel = {
  make: make,
  destroy: destroy,
  send: send,
  recv: recv,
  onDestroyed: onDestroyed,
  reveal: reveal,
  getEditorLayout: getEditorLayout,
  moveToBottom: moveToBottom,
  moveToRight: moveToRight
};

async function send$1(view, requestOrEvent) {
  var match = view.status;
  if (typeof match !== "object") {
    var stringified = JSON.stringify(View$AgdaModeVscode.RequestOrEventToView.encode(requestOrEvent));
    if (requestOrEvent.TAG === "Request") {
      var promise = Chan$AgdaModeVscode.once(view.onResponse);
      await view.panel.webview.postMessage(stringified);
      return await promise;
    }
    await view.panel.webview.postMessage(stringified);
    return ;
  }
  var queuedRequests = match._0;
  if (requestOrEvent.TAG === "Request") {
    var req = requestOrEvent._0;
    return await new Promise((function (resolve, param) {
                  queuedRequests.push([
                        req,
                        (function (x) {
                            if (x.TAG === "Response") {
                              return resolve(x._0);
                            } else {
                              return resolve(undefined);
                            }
                          })
                      ]);
                }));
  }
  match._1.push(requestOrEvent._0);
}

async function sendEvent(view, $$event) {
  await send$1(view, {
        TAG: "Event",
        _0: $$event
      });
}

async function sendRequest(view, request, callback) {
  var response = await send$1(view, {
        TAG: "Request",
        _0: request
      });
  if (response !== undefined) {
    return await callback(response);
  }
  
}

function onEvent(view, callback) {
  return new Vscode.Disposable(Chan$AgdaModeVscode.on(view.onEvent, callback));
}

function make$1(title, extensionPath) {
  var view = {
    panel: make(title, extensionPath),
    onResponse: Chan$AgdaModeVscode.make(),
    onEvent: Chan$AgdaModeVscode.make(),
    subscriptions: [],
    status: {
      TAG: "Uninitialized",
      _0: [],
      _1: []
    }
  };
  var match = Config$AgdaModeVscode.View.getPanelMountingPosition();
  if (match === "Bottom") {
    moveToBottom();
  } else {
    moveToRight();
  }
  Js_array.push(view.panel.webview.onDidReceiveMessage(function (json) {
            var e = Json$JsonCombinators.decode(json, View$AgdaModeVscode.ResponseOrEventFromView.decode);
            if (e.TAG === "Ok") {
              var res = e._0;
              if (res.TAG === "Response") {
                return Chan$AgdaModeVscode.emit(view.onResponse, res._0);
              } else {
                return Chan$AgdaModeVscode.emit(view.onEvent, res._0);
              }
            }
            console.log("[ panic ][ Webview.onDidReceiveMessage JSON decode error ]", e._0);
          }), view.subscriptions);
  Js_array.push(view.panel.onDidDispose(function () {
            Chan$AgdaModeVscode.emit(view.onEvent, "Destroyed");
          }), view.subscriptions);
  Js_array.push(new Vscode.Disposable(Chan$AgdaModeVscode.on(view.onEvent, (function (x) {
                  if (typeof x === "object") {
                    return ;
                  }
                  if (x !== "Initialized") {
                    return ;
                  }
                  var match = view.status;
                  if (typeof match !== "object") {
                    return ;
                  }
                  view.status = "Initialized";
                  match._0.forEach(function (param) {
                        var resolve = param[1];
                        send$1(view, {
                                TAG: "Request",
                                _0: param[0]
                              }).then(function (x) {
                              if (x !== undefined) {
                                return resolve({
                                            TAG: "Response",
                                            _0: x
                                          });
                              }
                              
                            });
                      });
                  match._1.forEach(function ($$event) {
                        send$1(view, {
                              TAG: "Event",
                              _0: $$event
                            });
                      });
                }))), view.subscriptions);
  return view;
}

function destroy$1(view) {
  Chan$AgdaModeVscode.destroy(view.onResponse);
  Chan$AgdaModeVscode.destroy(view.onEvent);
  view.panel.dispose();
  view.subscriptions.forEach(function (prim) {
        return prim.dispose();
      });
}

function onceDestroyed(view) {
  var match = Util$AgdaModeVscode.Promise_.pending();
  var resolve = match[1];
  var disposable = Chan$AgdaModeVscode.on(view.onEvent, (function (response) {
          if (typeof response !== "object" && response === "Destroyed") {
            return resolve();
          }
          
        }));
  return match[0].then(disposable);
}

function reveal$1(view) {
  reveal(view.panel);
}

var Module = {
  make: make$1,
  destroy: destroy$1,
  sendEvent: sendEvent,
  sendRequest: sendRequest,
  onEvent: onEvent,
  onceDestroyed: onceDestroyed,
  reveal: reveal$1
};

exports.WebviewPanel = WebviewPanel;
exports.Module = Module;
exports.make = make$1;
exports.destroy = destroy$1;
exports.sendEvent = sendEvent;
exports.sendRequest = sendRequest;
exports.onEvent = onEvent;
exports.onceDestroyed = onceDestroyed;
exports.reveal = reveal$1;
/* vscode Not a pure module */
